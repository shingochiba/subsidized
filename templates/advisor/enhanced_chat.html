{% extends 'advisor/chat.html' %}

{% block extra_css %}
{{ block.super }}
<style>
/* å¼·åŒ–ç‰ˆãƒãƒ£ãƒƒãƒˆå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.enhanced-features {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.feature-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    transition: transform 0.2s ease;
}

.feature-item:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.2);
}

.confidence-meter {
    background: #f8f9fa;
    border-radius: 20px;
    height: 6px;
    margin: 10px 0;
    overflow: hidden;
}

.confidence-bar {
    height: 100%;
    border-radius: 20px;
    transition: width 0.3s ease, background-color 0.3s ease;
}

.confidence-high { background: #28a745; }
.confidence-medium { background: #ffc107; }
.confidence-low { background: #dc3545; }

.message.assistant .message-content {
    position: relative;
}

.message-metadata {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e9ecef;
}

.intent-badge {
    display: inline-block;
    background: #17a2b8;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.65rem;
    margin-right: 5px;
}

.subsidy-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    transition: all 0.2s ease;
}

.subsidy-card:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.subsidy-name {
    font-weight: 600;
    color: #007bff;
    margin-bottom: 5px;
}

.subsidy-amount {
    color: #28a745;
    font-weight: 500;
}

.context-info {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.9rem;
}

.ai-thinking {
    display: none;
    background: rgba(23, 162, 184, 0.1);
    border: 1px solid rgba(23, 162, 184, 0.3);
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    font-style: italic;
    color: #17a2b8;
}

.suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
}

.suggestion-chip {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.suggestion-chip:hover {
    background: #bbdefb;
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- å¼·åŒ–ç‰ˆæ©Ÿèƒ½ç´¹ä»‹ -->
            <div class="enhanced-features">
                <div class="text-center">
                    <h3><i class="fas fa-magic"></i> AIè£œåŠ©é‡‘ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ å¼·åŒ–ç‰ˆ</h3>
                    <p class="mb-0">æ¬¡ä¸–ä»£AIæŠ€è¡“ã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªè£œåŠ©é‡‘ãƒãƒƒãƒãƒ³ã‚°</p>
                </div>
                
                <div class="feature-grid">
                    <div class="feature-item">
                        <i class="fas fa-brain fa-2x mb-2"></i>
                        <h6>æ–‡è„ˆç†è§£</h6>
                        <small>ä¼šè©±ã®æµã‚Œã‚’ç†è§£ã—ãŸå›ç­”</small>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-target fa-2x mb-2"></i>
                        <h6>æ„å›³èªè­˜</h6>
                        <small>è³ªå•ã®çœŸæ„ã‚’æ­£ç¢ºã«æŠŠæ¡</small>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h6>ä¿¡é ¼åº¦è¡¨ç¤º</h6>
                        <small>å›ç­”ã®ç¢ºå®Ÿæ€§ã‚’æ•°å€¤åŒ–</small>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-lightbulb fa-2x mb-2"></i>
                        <h6>ææ¡ˆæ©Ÿèƒ½</h6>
                        <small>æœ€é©ãªè£œåŠ©é‡‘ã‚’è‡ªå‹•ææ¡ˆ</small>
                    </div>
                </div>
            </div>

            <!-- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ± -->
            <div class="context-info">
                <i class="fas fa-info-circle"></i>
                <strong>å¼·åŒ–ç‰ˆã®ç‰¹å¾´ï¼š</strong>
                ä¼šè©±å±¥æ­´ã‚’è¨˜æ†¶ã—ã€ã‚ãªãŸã®äº‹æ¥­ã«ã‚ˆã‚Šé©ã—ãŸè£œåŠ©é‡‘ã‚’ç¶™ç¶šçš„ã«ææ¡ˆã—ã¾ã™ã€‚
                è³ªå•ã®æ„å›³ã‚’åˆ†æã—ã€ã‚ˆã‚Šå…·ä½“çš„ã§å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
            </div>

            <!-- äº‹æ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› -->
            <div class="business-context">
                <h6><i class="fas fa-building"></i> äº‹æ¥­æƒ…å ±ï¼ˆæ¨å¥¨ï¼‰</h6>
                <p class="small text-muted mb-3">ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ãŸã‚ã€äº‹æ¥­æƒ…å ±ã‚’ã”å…¥åŠ›ãã ã•ã„</p>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label small">äº‹æ¥­ç¨®åˆ¥</label>
                        <select class="form-select form-select-sm" id="businessType">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="è£½é€ æ¥­">è£½é€ æ¥­</option>
                            <option value="å°å£²æ¥­">å°å£²æ¥­</option>
                            <option value="ã‚µãƒ¼ãƒ“ã‚¹æ¥­">ã‚µãƒ¼ãƒ“ã‚¹æ¥­</option>
                            <option value="ITãƒ»æƒ…å ±é€šä¿¡æ¥­">ITãƒ»æƒ…å ±é€šä¿¡æ¥­</option>
                            <option value="å»ºè¨­æ¥­">å»ºè¨­æ¥­</option>
                            <option value="è¾²æ¥­ãƒ»æ—æ¥­ãƒ»æ¼æ¥­">è¾²æ¥­ãƒ»æ—æ¥­ãƒ»æ¼æ¥­</option>
                            <option value="é‹è¼¸æ¥­">é‹è¼¸æ¥­</option>
                            <option value="åŒ»ç™‚ãƒ»ç¦ç¥‰">åŒ»ç™‚ãƒ»ç¦ç¥‰</option>
                            <option value="æ•™è‚²ãƒ»å­¦ç¿’æ”¯æ´æ¥­">æ•™è‚²ãƒ»å­¦ç¿’æ”¯æ´æ¥­</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">ä¼æ¥­è¦æ¨¡</label>
                        <select class="form-select form-select-sm" id="companySize">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="å€‹äººäº‹æ¥­ä¸»">å€‹äººäº‹æ¥­ä¸»</option>
                            <option value="å°è¦æ¨¡ä¼æ¥­">å°è¦æ¨¡ä¼æ¥­ï¼ˆå¾“æ¥­å“¡20åä»¥ä¸‹ï¼‰</option>
                            <option value="ä¸­å°ä¼æ¥­">ä¸­å°ä¼æ¥­ï¼ˆå¾“æ¥­å“¡300åä»¥ä¸‹ï¼‰</option>
                            <option value="å¤§ä¼æ¥­">å¤§ä¼æ¥­ï¼ˆå¾“æ¥­å“¡300åä»¥ä¸Šï¼‰</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">æ‰€åœ¨åœ°</label>
                        <select class="form-select form-select-sm" id="region">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
                            <option value="æ±åŒ—">æ±åŒ—åœ°æ–¹</option>
                            <option value="é–¢æ±">é–¢æ±åœ°æ–¹</option>
                            <option value="ä¸­éƒ¨">ä¸­éƒ¨åœ°æ–¹</option>
                            <option value="é–¢è¥¿">é–¢è¥¿åœ°æ–¹</option>
                            <option value="ä¸­å›½">ä¸­å›½åœ°æ–¹</option>
                            <option value="å››å›½">å››å›½åœ°æ–¹</option>
                            <option value="ä¹å·">ä¹å·åœ°æ–¹</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">
                                <i class="fas fa-magic"></i> AIè£œåŠ©é‡‘ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼
                                <span class="badge bg-success ms-2">å¼·åŒ–ç‰ˆ</span>
                            </h6>
                            <small>é«˜ç²¾åº¦AIã«ã‚ˆã‚‹è£œåŠ©é‡‘ãƒãƒƒãƒãƒ³ã‚°</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="exportHistory()">
                                <i class="fas fa-download"></i> å±¥æ­´
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="clearChat()">
                                <i class="fas fa-trash"></i> ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                    <div class="message assistant">
                        <div class="message-avatar">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="message-content">
                            <strong>ğŸ¯ AIè£œåŠ©é‡‘ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ å¼·åŒ–ç‰ˆã¸ã‚ˆã†ã“ãï¼</strong><br><br>
                            
                            ç§ã¯æ¬¡ä¸–ä»£AIæŠ€è¡“ã‚’æ´»ç”¨ã—ãŸè£œåŠ©é‡‘ãƒãƒƒãƒãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚<br>
                            ä»¥ä¸‹ã®ç‰¹å¾´ã§ã€ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ï¼š<br><br>
                            
                            âœ… <strong>æ–‡è„ˆç†è§£</strong>ï¼šä¼šè©±ã®æµã‚Œã‚’è¨˜æ†¶<br>
                            âœ… <strong>æ„å›³åˆ†æ</strong>ï¼šè³ªå•ã®çœŸæ„ã‚’æ­£ç¢ºã«æŠŠæ¡<br>
                            âœ… <strong>ä¿¡é ¼åº¦è¡¨ç¤º</strong>ï¼šå›ç­”ã®ç¢ºå®Ÿæ€§ã‚’æ•°å€¤åŒ–<br>
                            âœ… <strong>å€‹åˆ¥æœ€é©åŒ–</strong>ï¼šäº‹æ¥­ç‰¹æ€§ã«å¿œã˜ãŸææ¡ˆ<br><br>
                            
                            ã©ã®ã‚ˆã†ãªè£œåŠ©é‡‘ã‚’ãŠæ¢ã—ã§ã™ã‹ï¼Ÿå…·ä½“çš„ãªäº‹æ¥­å†…å®¹ã‚„æŠ•è³‡è¨ˆç”»ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚
                            
                            <div class="message-metadata">
                                <span class="intent-badge">welcome</span>
                                <span>ä¿¡é ¼åº¦: 100%</span> â€¢ 
                                <span>å¿œç­”æ™‚é–“: å³åº§</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-thinking" id="aiThinking">
                    <i class="fas fa-brain"></i> AIãŒæ–‡è„ˆã‚’åˆ†æã—ã€æœ€é©ãªå›ç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="message assistant">
                        <div class="message-avatar">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="message-content">
                            AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­<span class="typing-dots"></span>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="input-group">
                        <textarea 
                            class="form-control" 
                            id="messageInput" 
                            placeholder="å…·ä½“çš„ãªäº‹æ¥­å†…å®¹ã‚„æŠ•è³‡è¨ˆç”»ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„..."
                            rows="1"
                            style="resize: none;"
                        ></textarea>
                        <button class="btn" id="sendButton" type="button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆææ¡ˆ -->
            <div class="quick-questions">
                <h6><i class="fas fa-lightbulb text-warning"></i> ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆææ¡ˆ</h6>
                <div class="suggestion-chips" id="suggestionChips">
                    <span class="suggestion-chip" onclick="sendQuickQuestion('ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã®ãŸã‚ã®è¨­å‚™æŠ•è³‡ã«ä½¿ãˆã‚‹è£œåŠ©é‡‘ã‚’æ•™ãˆã¦ãã ã•ã„')">
                        ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–æŠ•è³‡
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ã«é–¢é€£ã™ã‚‹è£œåŠ©é‡‘ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ')">
                        ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('æ–°äº‹æ¥­å±•é–‹ã®ãŸã‚ã®è£œåŠ©é‡‘ã‚’æ¢ã—ã¦ã„ã¾ã™')">
                        æ–°äº‹æ¥­å±•é–‹
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('äººæè‚²æˆãƒ»æ•™è‚²è¨“ç·´ã®è£œåŠ©é‡‘ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„')">
                        äººæè‚²æˆ
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('è¼¸å‡ºãƒ»æµ·å¤–å±•é–‹æ”¯æ´ã®åˆ¶åº¦ã‚’çŸ¥ã‚ŠãŸã„ã§ã™')">
                        æµ·å¤–å±•é–‹
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('ç ”ç©¶é–‹ç™ºãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£ã®è£œåŠ©é‡‘ã¯ï¼Ÿ')">
                        ç ”ç©¶é–‹ç™º
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let sessionId = generateSessionId();
let isWaiting = false;
let conversationHistory = [];

function generateSessionId() {
    return 'enhanced_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

function sendQuickQuestion(question) {
    document.getElementById('messageInput').value = question;
    sendMessage();
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="message assistant">
            <div class="message-avatar">
                <i class="fas fa-magic"></i>
            </div>
            <div class="message-content">
                <strong>ğŸ¯ AIè£œåŠ©é‡‘ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ å¼·åŒ–ç‰ˆã¸ã‚ˆã†ã“ãï¼</strong><br><br>
                
                ç§ã¯æ¬¡ä¸–ä»£AIæŠ€è¡“ã‚’æ´»ç”¨ã—ãŸè£œåŠ©é‡‘ãƒãƒƒãƒãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚<br>
                ä»¥ä¸‹ã®ç‰¹å¾´ã§ã€ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ï¼š<br><br>
                
                âœ… <strong>æ–‡è„ˆç†è§£</strong>ï¼šä¼šè©±ã®æµã‚Œã‚’è¨˜æ†¶<br>
                âœ… <strong>æ„å›³åˆ†æ</strong>ï¼šè³ªå•ã®çœŸæ„ã‚’æ­£ç¢ºã«æŠŠæ¡<br>
                âœ… <strong>ä¿¡é ¼åº¦è¡¨ç¤º</strong>ï¼šå›ç­”ã®ç¢ºå®Ÿæ€§ã‚’æ•°å€¤åŒ–<br>
                âœ… <strong>å€‹åˆ¥æœ€é©åŒ–</strong>ï¼šäº‹æ¥­ç‰¹æ€§ã«å¿œã˜ãŸææ¡ˆ<br><br>
                
                ã©ã®ã‚ˆã†ãªè£œåŠ©é‡‘ã‚’ãŠæ¢ã—ã§ã™ã‹ï¼Ÿå…·ä½“çš„ãªäº‹æ¥­å†…å®¹ã‚„æŠ•è³‡è¨ˆç”»ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚
                
                <div class="message-metadata">
                    <span class="intent-badge">welcome</span>
                    <span>ä¿¡é ¼åº¦: 100%</span> â€¢ 
                    <span>å¿œç­”æ™‚é–“: å³åº§</span>
                </div>
            </div>
        </div>
    `;
    sessionId = generateSessionId();
    conversationHistory = [];
}

function addMessage(content, isUser = false, metadata = null) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
    
    const avatar = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-magic"></i>';
    
    let metadataHTML = '';
    if (metadata && !isUser) {
        metadataHTML = `
            <div class="message-metadata">
                ${metadata.intent ? `<span class="intent-badge">${metadata.intent}</span>` : ''}
                ${metadata.confidence ? `<span>ä¿¡é ¼åº¦: ${Math.round(metadata.confidence * 100)}%</span> â€¢ ` : ''}
                <span>å¿œç­”æ™‚é–“: ${metadata.responseTime || '1.2s'}</span>
            </div>
        `;
    }
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
            ${content}
            ${metadataHTML}
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
    conversationHistory.push({
        role: isUser ? 'user' : 'assistant',
        content: content,
        timestamp: new Date().toISOString(),
        metadata: metadata
    });
}

function showAIThinking() {
    document.getElementById('aiThinking').style.display = 'block';
    setTimeout(() => {
        document.getElementById('aiThinking').style.display = 'none';
        showTyping();
    }, 1500);
}

function showTyping() {
    document.getElementById('typingIndicator').style.display = 'block';
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTyping() {
    document.getElementById('typingIndicator').style.display = 'none';
}

function formatSubsidyRecommendations(subsidies) {
    if (!subsidies || subsidies.length === 0) return '';
    
    let html = '<br><br><strong>ğŸ¯ ãŠã™ã™ã‚ã®è£œåŠ©é‡‘åˆ¶åº¦ï¼š</strong><br>';
    subsidies.forEach(subsidy => {
        html += `
            <div class="subsidy-card">
                <div class="subsidy-name">${subsidy.name}</div>
                <div class="subsidy-amount">æœ€å¤§è£œåŠ©é¡: ${subsidy.max_amount?.toLocaleString() || 'è¦ç¢ºèª'}ä¸‡å††</div>
                <small class="text-muted">${subsidy.description || ''}</small>
            </div>
        `;
    });
    
    return html;
}

async function sendMessage() {
    if (isWaiting) return;
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMessage(message, true);
    messageInput.value = '';
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    isWaiting = true;
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    
    // AIæ€è€ƒã¨ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
    showAIThinking();
    
    const startTime = Date.now();
    
    try {
        // äº‹æ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        const businessType = document.getElementById('businessType').value;
        const companySize = document.getElementById('companySize').value;
        const region = document.getElementById('region').value;
        
        const response = await fetch('{% url "advisor:analyze_question" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                question: message,
                business_type: businessType,
                company_size: companySize,
                region: region,
                session_id: sessionId,
                conversation_history: conversationHistory.slice(-5), // ç›´è¿‘5ä»¶ã®å±¥æ­´
                enhanced_mode: true
            })
        });
        
        const data = await response.json();
        const responseTime = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
        
        hideTyping();
        
        if (data.success) {
            const result = data.result;
            let responseHTML = result.answer;
            
            // æ¨å¥¨è£œåŠ©é‡‘ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
            if (result.recommended_subsidies && result.recommended_subsidies.length > 0) {
                responseHTML += formatSubsidyRecommendations(result.recommended_subsidies);
            }
            
            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            const metadata = {
                intent: result.question_type || 'general',
                confidence: result.confidence_score || 0.8,
                responseTime: responseTime
            };
            
            addMessage(responseHTML, false, metadata);
            
            // å‹•çš„ææ¡ˆãƒãƒƒãƒ—ã‚’æ›´æ–°
            updateSuggestionChips(result);
            
        } else {
            addMessage(
                'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
                false,
                { intent: 'error', confidence: 0.0, responseTime: responseTime }
            );
        }
        
    } catch (error) {
        console.error('Error:', error);
        hideTyping();
        const responseTime = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
        addMessage(
            'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
            false,
            { intent: 'error', confidence: 0.0, responseTime: responseTime }
        );
    }
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    isWaiting = false;
    sendButton.disabled = false;
}

function updateSuggestionChips(result) {
    // æ–‡è„ˆã«å¿œã˜ãŸææ¡ˆã‚’å‹•çš„ã«ç”Ÿæˆ
    const suggestions = [
        'è©³ã—ã„ç”³è«‹æ‰‹ç¶šãã‚’æ•™ãˆã¦',
        'å¿…è¦æ›¸é¡ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„',
        'æ¡æŠç‡ã‚’ä¸Šã’ã‚‹ã‚³ãƒ„ã¯ï¼Ÿ',
        'ä»–ã®é–¢é€£åˆ¶åº¦ã¯ã‚ã‚‹ï¼Ÿ'
    ];
    
    const chipsContainer = document.getElementById('suggestionChips');
    const newChips = suggestions.map(suggestion => 
        `<span class="suggestion-chip" onclick="sendQuickQuestion('${suggestion}')">${suggestion}</span>`
    ).join('');
    
    // ä¸€éƒ¨ã®ãƒãƒƒãƒ—ã‚’æ›´æ–°ï¼ˆå…¨éƒ¨ã§ã¯ãªãï¼‰
    if (chipsContainer.children.length > 4) {
        chipsContainer.innerHTML = chipsContainer.innerHTML.split('</span>').slice(0, 4).join('</span>') + 
                                  '</span>' + newChips;
    }
}

function exportHistory() {
    const data = JSON.stringify(conversationHistory, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat_history_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    // Enterã‚­ãƒ¼ã§é€ä¿¡
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    sendButton.addEventListener('click', sendMessage);
    
    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
});
</script>

<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}