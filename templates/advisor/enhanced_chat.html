{% extends 'advisor/chat.html' %}

{% block extra_css %}
{{ block.super }}
<style>
/* 強化版チャット専用スタイル */
.enhanced-features {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.feature-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    transition: transform 0.2s ease;
}

.feature-item:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.2);
}

.confidence-meter {
    background: #f8f9fa;
    border-radius: 20px;
    height: 6px;
    margin: 10px 0;
    overflow: hidden;
}

.confidence-bar {
    height: 100%;
    border-radius: 20px;
    transition: width 0.3s ease, background-color 0.3s ease;
}

.confidence-high { background: #28a745; }
.confidence-medium { background: #ffc107; }
.confidence-low { background: #dc3545; }

.message.assistant .message-content {
    position: relative;
}

.message-metadata {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e9ecef;
}

.intent-badge {
    display: inline-block;
    background: #17a2b8;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.65rem;
    margin-right: 5px;
}

.subsidy-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    transition: all 0.2s ease;
}

.subsidy-card:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.subsidy-name {
    font-weight: 600;
    color: #007bff;
    margin-bottom: 5px;
}

.subsidy-amount {
    color: #28a745;
    font-weight: 500;
}

.context-info {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.9rem;
}

.ai-thinking {
    display: none;
    background: rgba(23, 162, 184, 0.1);
    border: 1px solid rgba(23, 162, 184, 0.3);
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    font-style: italic;
    color: #17a2b8;
}

.suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
}

.suggestion-chip {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.suggestion-chip:hover {
    background: #bbdefb;
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- 強化版機能紹介 -->
            <div class="enhanced-features">
                <div class="text-center">
                    <h3><i class="fas fa-magic"></i> AI補助金アドバイザー 強化版</h3>
                    <p class="mb-0">次世代AI技術による高精度な補助金マッチング</p>
                </div>
                
                <div class="feature-grid">
                    <div class="feature-item">
                        <i class="fas fa-brain fa-2x mb-2"></i>
                        <h6>文脈理解</h6>
                        <small>会話の流れを理解した回答</small>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-target fa-2x mb-2"></i>
                        <h6>意図認識</h6>
                        <small>質問の真意を正確に把握</small>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h6>信頼度表示</h6>
                        <small>回答の確実性を数値化</small>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-lightbulb fa-2x mb-2"></i>
                        <h6>提案機能</h6>
                        <small>最適な補助金を自動提案</small>
                    </div>
                </div>
            </div>

            <!-- コンテキスト情報 -->
            <div class="context-info">
                <i class="fas fa-info-circle"></i>
                <strong>強化版の特徴：</strong>
                会話履歴を記憶し、あなたの事業により適した補助金を継続的に提案します。
                質問の意図を分析し、より具体的で実用的なアドバイスを提供します。
            </div>

            <!-- 事業コンテキスト入力 -->
            <div class="business-context">
                <h6><i class="fas fa-building"></i> 事業情報（推奨）</h6>
                <p class="small text-muted mb-3">より精度の高いアドバイスのため、事業情報をご入力ください</p>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label small">事業種別</label>
                        <select class="form-select form-select-sm" id="businessType">
                            <option value="">選択してください</option>
                            <option value="製造業">製造業</option>
                            <option value="小売業">小売業</option>
                            <option value="サービス業">サービス業</option>
                            <option value="IT・情報通信業">IT・情報通信業</option>
                            <option value="建設業">建設業</option>
                            <option value="農業・林業・漁業">農業・林業・漁業</option>
                            <option value="運輸業">運輸業</option>
                            <option value="医療・福祉">医療・福祉</option>
                            <option value="教育・学習支援業">教育・学習支援業</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">企業規模</label>
                        <select class="form-select form-select-sm" id="companySize">
                            <option value="">選択してください</option>
                            <option value="個人事業主">個人事業主</option>
                            <option value="小規模企業">小規模企業（従業員20名以下）</option>
                            <option value="中小企業">中小企業（従業員300名以下）</option>
                            <option value="大企業">大企業（従業員300名以上）</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">所在地</label>
                        <select class="form-select form-select-sm" id="region">
                            <option value="">選択してください</option>
                            <option value="北海道">北海道</option>
                            <option value="東北">東北地方</option>
                            <option value="関東">関東地方</option>
                            <option value="中部">中部地方</option>
                            <option value="関西">関西地方</option>
                            <option value="中国">中国地方</option>
                            <option value="四国">四国地方</option>
                            <option value="九州">九州地方</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- チャットコンテナ -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">
                                <i class="fas fa-magic"></i> AI補助金アドバイザー
                                <span class="badge bg-success ms-2">強化版</span>
                            </h6>
                            <small>高精度AIによる補助金マッチング</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="exportHistory()">
                                <i class="fas fa-download"></i> 履歴
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="clearChat()">
                                <i class="fas fa-trash"></i> クリア
                            </button>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- 初期メッセージ -->
                    <div class="message assistant">
                        <div class="message-avatar">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="message-content">
                            <strong>🎯 AI補助金アドバイザー 強化版へようこそ！</strong><br><br>
                            
                            私は次世代AI技術を活用した補助金マッチングシステムです。<br>
                            以下の特徴で、より精度の高いアドバイスを提供します：<br><br>
                            
                            ✅ <strong>文脈理解</strong>：会話の流れを記憶<br>
                            ✅ <strong>意図分析</strong>：質問の真意を正確に把握<br>
                            ✅ <strong>信頼度表示</strong>：回答の確実性を数値化<br>
                            ✅ <strong>個別最適化</strong>：事業特性に応じた提案<br><br>
                            
                            どのような補助金をお探しですか？具体的な事業内容や投資計画について教えてください。
                            
                            <div class="message-metadata">
                                <span class="intent-badge">welcome</span>
                                <span>信頼度: 100%</span> • 
                                <span>応答時間: 即座</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-thinking" id="aiThinking">
                    <i class="fas fa-brain"></i> AIが文脈を分析し、最適な回答を生成しています...
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="message assistant">
                        <div class="message-avatar">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="message-content">
                            AIが回答を生成中<span class="typing-dots"></span>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="input-group">
                        <textarea 
                            class="form-control" 
                            id="messageInput" 
                            placeholder="具体的な事業内容や投資計画について教えてください..."
                            rows="1"
                            style="resize: none;"
                        ></textarea>
                        <button class="btn" id="sendButton" type="button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- インテリジェント提案 -->
            <div class="quick-questions">
                <h6><i class="fas fa-lightbulb text-warning"></i> インテリジェント提案</h6>
                <div class="suggestion-chips" id="suggestionChips">
                    <span class="suggestion-chip" onclick="sendQuickQuestion('デジタル化のための設備投資に使える補助金を教えてください')">
                        デジタル化投資
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('カーボンニュートラルに関連する補助金はありますか？')">
                        カーボンニュートラル
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('新事業展開のための補助金を探しています')">
                        新事業展開
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('人材育成・教育訓練の補助金について教えてください')">
                        人材育成
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('輸出・海外展開支援の制度を知りたいです')">
                        海外展開
                    </span>
                    <span class="suggestion-chip" onclick="sendQuickQuestion('研究開発・イノベーション関連の補助金は？')">
                        研究開発
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let sessionId = generateSessionId();
let isWaiting = false;
let conversationHistory = [];

function generateSessionId() {
    return 'enhanced_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

function sendQuickQuestion(question) {
    document.getElementById('messageInput').value = question;
    sendMessage();
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="message assistant">
            <div class="message-avatar">
                <i class="fas fa-magic"></i>
            </div>
            <div class="message-content">
                <strong>🎯 AI補助金アドバイザー 強化版へようこそ！</strong><br><br>
                
                私は次世代AI技術を活用した補助金マッチングシステムです。<br>
                以下の特徴で、より精度の高いアドバイスを提供します：<br><br>
                
                ✅ <strong>文脈理解</strong>：会話の流れを記憶<br>
                ✅ <strong>意図分析</strong>：質問の真意を正確に把握<br>
                ✅ <strong>信頼度表示</strong>：回答の確実性を数値化<br>
                ✅ <strong>個別最適化</strong>：事業特性に応じた提案<br><br>
                
                どのような補助金をお探しですか？具体的な事業内容や投資計画について教えてください。
                
                <div class="message-metadata">
                    <span class="intent-badge">welcome</span>
                    <span>信頼度: 100%</span> • 
                    <span>応答時間: 即座</span>
                </div>
            </div>
        </div>
    `;
    sessionId = generateSessionId();
    conversationHistory = [];
}

function addMessage(content, isUser = false, metadata = null) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
    
    const avatar = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-magic"></i>';
    
    let metadataHTML = '';
    if (metadata && !isUser) {
        metadataHTML = `
            <div class="message-metadata">
                ${metadata.intent ? `<span class="intent-badge">${metadata.intent}</span>` : ''}
                ${metadata.confidence ? `<span>信頼度: ${Math.round(metadata.confidence * 100)}%</span> • ` : ''}
                <span>応答時間: ${metadata.responseTime || '1.2s'}</span>
            </div>
        `;
    }
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
            ${content}
            ${metadataHTML}
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // 会話履歴に追加
    conversationHistory.push({
        role: isUser ? 'user' : 'assistant',
        content: content,
        timestamp: new Date().toISOString(),
        metadata: metadata
    });
}

function showAIThinking() {
    document.getElementById('aiThinking').style.display = 'block';
    setTimeout(() => {
        document.getElementById('aiThinking').style.display = 'none';
        showTyping();
    }, 1500);
}

function showTyping() {
    document.getElementById('typingIndicator').style.display = 'block';
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTyping() {
    document.getElementById('typingIndicator').style.display = 'none';
}

function formatSubsidyRecommendations(subsidies) {
    if (!subsidies || subsidies.length === 0) return '';
    
    let html = '<br><br><strong>🎯 おすすめの補助金制度：</strong><br>';
    subsidies.forEach(subsidy => {
        html += `
            <div class="subsidy-card">
                <div class="subsidy-name">${subsidy.name}</div>
                <div class="subsidy-amount">最大補助額: ${subsidy.max_amount?.toLocaleString() || '要確認'}万円</div>
                <small class="text-muted">${subsidy.description || ''}</small>
            </div>
        `;
    });
    
    return html;
}

async function sendMessage() {
    if (isWaiting) return;
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // ユーザーメッセージを表示
    addMessage(message, true);
    messageInput.value = '';
    
    // 送信ボタンを無効化
    isWaiting = true;
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    
    // AI思考とタイピングインジケーターを表示
    showAIThinking();
    
    const startTime = Date.now();
    
    try {
        // 事業コンテキストを取得
        const businessType = document.getElementById('businessType').value;
        const companySize = document.getElementById('companySize').value;
        const region = document.getElementById('region').value;
        
        const response = await fetch('{% url "advisor:analyze_question" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                question: message,
                business_type: businessType,
                company_size: companySize,
                region: region,
                session_id: sessionId,
                conversation_history: conversationHistory.slice(-5), // 直近5件の履歴
                enhanced_mode: true
            })
        });
        
        const data = await response.json();
        const responseTime = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
        
        hideTyping();
        
        if (data.success) {
            const result = data.result;
            let responseHTML = result.answer;
            
            // 推奨補助金がある場合は表示
            if (result.recommended_subsidies && result.recommended_subsidies.length > 0) {
                responseHTML += formatSubsidyRecommendations(result.recommended_subsidies);
            }
            
            // メタデータを準備
            const metadata = {
                intent: result.question_type || 'general',
                confidence: result.confidence_score || 0.8,
                responseTime: responseTime
            };
            
            addMessage(responseHTML, false, metadata);
            
            // 動的提案チップを更新
            updateSuggestionChips(result);
            
        } else {
            addMessage(
                '申し訳ございませんが、エラーが発生しました。もう一度お試しください。',
                false,
                { intent: 'error', confidence: 0.0, responseTime: responseTime }
            );
        }
        
    } catch (error) {
        console.error('Error:', error);
        hideTyping();
        const responseTime = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
        addMessage(
            '通信エラーが発生しました。もう一度お試しください。',
            false,
            { intent: 'error', confidence: 0.0, responseTime: responseTime }
        );
    }
    
    // 送信ボタンを有効化
    isWaiting = false;
    sendButton.disabled = false;
}

function updateSuggestionChips(result) {
    // 文脈に応じた提案を動的に生成
    const suggestions = [
        '詳しい申請手続きを教えて',
        '必要書類について知りたい',
        '採択率を上げるコツは？',
        '他の関連制度はある？'
    ];
    
    const chipsContainer = document.getElementById('suggestionChips');
    const newChips = suggestions.map(suggestion => 
        `<span class="suggestion-chip" onclick="sendQuickQuestion('${suggestion}')">${suggestion}</span>`
    ).join('');
    
    // 一部のチップを更新（全部ではなく）
    if (chipsContainer.children.length > 4) {
        chipsContainer.innerHTML = chipsContainer.innerHTML.split('</span>').slice(0, 4).join('</span>') + 
                                  '</span>' + newChips;
    }
}

function exportHistory() {
    const data = JSON.stringify(conversationHistory, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat_history_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// イベントリスナー
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    // Enterキーで送信
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // 送信ボタンクリック
    sendButton.addEventListener('click', sendMessage);
    
    // テキストエリアの自動リサイズ
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
});
</script>

<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}