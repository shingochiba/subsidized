# advisor/services/nlp_ai_advisor.py - èªè­˜ç²¾åº¦å‘ä¸Šç‰ˆ

import requests
import json
import re
from django.conf import settings
from ..models import SubsidyType, Answer, ConversationHistory

class NLPAIAdvisorService:
    """è‡ªç„¶è¨€èªå‡¦ç†å¯¾å¿œã®é«˜åº¦ãªAIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ï¼ˆèªè­˜ç²¾åº¦å‘ä¸Šç‰ˆï¼‰"""
    
    def __init__(self):
        self.dify_api_url = getattr(settings, 'DIFY_API_URL', '')
        self.dify_api_key = getattr(settings, 'DIFY_API_KEY', '')
        self.headers = {
            'Authorization': f'Bearer {self.dify_api_key}',
            'Content-Type': 'application/json'
        }
        
        # è£œåŠ©é‡‘ãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰èª­ã¿è¾¼ã¿
        self.subsidies = list(SubsidyType.objects.all())
        self._initialize_nlp_patterns()
    
    def _initialize_nlp_patterns(self):
        """è‡ªç„¶è¨€èªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆæœŸåŒ–"""
        
        # å®Œå…¨ç‰ˆè£œåŠ©é‡‘ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¾æ›¸ï¼ˆç¾åœ¨ã®å…¨è£œåŠ©é‡‘ã«å¯¾å¿œï¼‰
        self.subsidy_aliases = {
            'ITå°å…¥è£œåŠ©é‡‘': [
                'itå°å…¥', 'ï¼©ï¼´å°å…¥', 'ã‚¢ã‚¤ãƒ†ã‚£ãƒ¼å°å…¥', 'ITãƒ„ãƒ¼ãƒ«', 'ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–è£œåŠ©',
                'itå°å…¥è£œåŠ©é‡‘', 'ITå°å…¥è£œåŠ©é‡‘', 'ITã‚·ã‚¹ãƒ†ãƒ ', 'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è£œåŠ©',
                'ãƒ‡ã‚¸ã‚¿ãƒ«è£œåŠ©', 'ã‚·ã‚¹ãƒ†ãƒ å°å…¥', 'ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–æ”¯æ´', 'ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–',
                'ã‚·ã‚¹ãƒ†ãƒ åŒ–', 'ITåŒ–', 'ãƒ‡ã‚¸ã‚¿ãƒ«å¤‰é©', 'dx'
            ],
            'ITå°å…¥è£œåŠ©é‡‘2025': [
                'itå°å…¥', 'ï¼©ï¼´å°å…¥', 'ã‚¢ã‚¤ãƒ†ã‚£ãƒ¼å°å…¥', 'ITãƒ„ãƒ¼ãƒ«', 'ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–è£œåŠ©',
                'itå°å…¥è£œåŠ©é‡‘', 'ITå°å…¥è£œåŠ©é‡‘', 'ITã‚·ã‚¹ãƒ†ãƒ ', 'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è£œåŠ©',
                'ãƒ‡ã‚¸ã‚¿ãƒ«è£œåŠ©', 'ã‚·ã‚¹ãƒ†ãƒ å°å…¥', 'ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–æ”¯æ´', 'ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–',
                'ã‚·ã‚¹ãƒ†ãƒ åŒ–', 'ITåŒ–', 'ãƒ‡ã‚¸ã‚¿ãƒ«å¤‰é©', 'dx', 'itå°å…¥2025'
            ],
            'ã‚‚ã®ã¥ãã‚Šè£œåŠ©é‡‘': [
                'ã‚‚ã®ã¥ãã‚Š', 'è£½é€ è£œåŠ©', 'è¨­å‚™æŠ•è³‡', 'ç”Ÿç”£æ€§å‘ä¸Š', 'ã‚‚ã®ã¥ãã‚Šè£œåŠ©é‡‘',
                'é©æ–°çš„ã‚µãƒ¼ãƒ“ã‚¹', 'è©¦ä½œå“é–‹ç™º', 'ç”Ÿç”£ãƒ—ãƒ­ã‚»ã‚¹æ”¹å–„', 'è¨­å‚™æ›´æ–°',
                'è£½é€ æ¥­è£œåŠ©', 'æ©Ÿæ¢°è¨­å‚™', 'è£½é€ ', 'å·¥å ´', 'ç”Ÿç”£'
            ],
            'å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘ã€ä¸€èˆ¬å‹ã€‘': [
                'æŒç¶šåŒ–', 'å°è¦æ¨¡æŒç¶š', 'è²©è·¯é–‹æ‹“', 'å°è¦æ¨¡äº‹æ¥­è€…', 'æŒç¶šåŒ–è£œåŠ©é‡‘',
                'æŒç¶šåŒ–ä¸€èˆ¬', 'ä¸€èˆ¬å‹æŒç¶šåŒ–', 'è²©è·¯æ‹¡å¤§', 'èªçŸ¥åº¦å‘ä¸Š',
                'å°è¦æ¨¡è£œåŠ©', 'è²©ä¿ƒæ”¯æ´', 'å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘',
                'è²©è·¯', 'è²©å£²ä¿ƒé€²', 'å–¶æ¥­æ”¯æ´'
            ],
            'å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘ã€å‰µæ¥­å‹ã€‘': [
                'æŒç¶šåŒ–å‰µæ¥­', 'å‰µæ¥­å‹æŒç¶šåŒ–', 'å‰µæ¥­è£œåŠ©', 'æ–°è¦é–‹æ¥­', 'èµ·æ¥­æ”¯æ´',
                'å‰µæ¥­5å¹´', 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—æ”¯æ´', 'å‰µæ¥­æœŸè£œåŠ©', 'å‰µæ¥­æ”¯æ´',
                'èµ·æ¥­è£œåŠ©', 'å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘å‰µæ¥­å‹', 'å‰µæ¥­',
                'èµ·æ¥­', 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—', 'æ–°è¦äº‹æ¥­'
            ],
            'çœåŠ›åŒ–æŠ•è³‡è£œåŠ©é‡‘': [
                'çœåŠ›åŒ–', 'çœåŠ›åŒ–æŠ•è³‡', 'äººæ‰‹ä¸è¶³è§£æ¶ˆ', 'è‡ªå‹•åŒ–', 'åŠ¹ç‡åŒ–æŠ•è³‡',
                'IoTè£œåŠ©', 'AIå°å…¥', 'ãƒ­ãƒœãƒƒãƒˆå°å…¥', 'çœäººåŒ–', 'åŠ´åƒåŠ›ä¸è¶³',
                'äººæä¸è¶³å¯¾ç­–', 'è‡ªå‹•åŒ–è¨­å‚™', 'çœåŠ›åŒ–æŠ•è³‡è£œåŠ©é‡‘',
                'äººæ‰‹ä¸è¶³', 'è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ', 'iot', 'ai', 'ãƒ­ãƒœãƒƒãƒˆ'
            ],
            'äº‹æ¥­æ‰¿ç¶™ãƒ»M&Aè£œåŠ©é‡‘': [
                'äº‹æ¥­æ‰¿ç¶™', 'æ‰¿ç¶™è£œåŠ©', 'å¼•ç¶™ã', 'å¾Œç¶™è€…', 'äº‹æ¥­æ‰¿ç¶™è£œåŠ©é‡‘',
                'M&Aè£œåŠ©', 'è²·åè£œåŠ©', 'çµŒå–¶æ‰¿ç¶™', 'ä¸–ä»£äº¤ä»£', 'äº‹æ¥­å¼•ç¶™ã',
                'maè£œåŠ©', 'ã‚¨ãƒ ã‚¢ãƒ³ãƒ‰ã‚¨ãƒ¼', 'äº‹æ¥­æ‰¿ç¶™ãƒ»M&Aè£œåŠ©é‡‘',
                'æ‰¿ç¶™', 'å¾Œç¶™', 'ma', 'm&a'
            ],
            'æ–°äº‹æ¥­é€²å‡ºè£œåŠ©é‡‘': [
                'æ–°äº‹æ¥­', 'æ–°åˆ†é‡é€²å‡º', 'äº‹æ¥­æ‹¡å¤§', 'å¤šè§’åŒ–', 'æ–°å•†å“é–‹ç™º',
                'æ–°ã‚µãƒ¼ãƒ“ã‚¹', 'å¸‚å ´é–‹æ‹“', 'äº‹æ¥­è»¢æ›', 'æ–°è¦äº‹æ¥­',
                'åˆ†é‡æ‹¡å¤§', 'æ–°äº‹æ¥­é€²å‡ºè£œåŠ©é‡‘', 'æ–°åˆ†é‡', 'å¤šè§’åŒ–'
            ],
            'æˆé•·åŠ é€ŸåŒ–è£œåŠ©é‡‘': [
                'æˆé•·åŠ é€Ÿ', 'æˆé•·ä¿ƒé€²', 'äº‹æ¥­æ‹¡å¤§', 'ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—', 'ç«¶äº‰åŠ›å¼·åŒ–',
                'ã‚°ãƒ­ãƒ¼ãƒãƒ«å±•é–‹', 'æµ·å¤–é€²å‡º', 'äººæè‚²æˆè£œåŠ©', 'æˆé•·æ”¯æ´',
                'æ‹¡å¤§æ”¯æ´', 'æˆé•·åŠ é€ŸåŒ–è£œåŠ©é‡‘', 'æˆé•·', 'æ‹¡å¤§', 'ã‚°ãƒ­ãƒ¼ãƒãƒ«'
            ],
            'çœã‚¨ãƒè¨ºæ–­ãƒ»çœã‚¨ãƒãƒ»éåŒ–çŸ³è»¢æ›è£œåŠ©é‡‘': [
                'çœã‚¨ãƒ', 'çœã‚¨ãƒãƒ«ã‚®ãƒ¼', 'éåŒ–çŸ³', 'ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', 'è„±ç‚­ç´ ',
                'å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼', 'CO2å‰Šæ¸›', 'ç’°å¢ƒå¯¾å¿œ', 'ã‚°ãƒªãƒ¼ãƒ³åŒ–',
                'çœã‚¨ãƒè¨­å‚™', 'ç’°å¢ƒè£œåŠ©', 'çœã‚¨ãƒè¨ºæ–­', 'ç’°å¢ƒ',
                'ã‚«ãƒ¼ãƒœãƒ³', 'è„±ç‚­ç´ åŒ–', 'co2'
            ],
            'é›‡ç”¨èª¿æ•´åŠ©æˆé‡‘': [
                'é›‡ç”¨èª¿æ•´', 'é›‡èª¿é‡‘', 'ä¼‘æ¥­è£œå„Ÿ', 'é›‡ç”¨ç¶­æŒ', 'åŠ´åƒè€…æ”¯æ´',
                'ä¸€æ™‚ä¼‘æ¥­', 'äº‹æ¥­ç¸®å°', 'é›‡ç”¨å®‰å®š', 'é›‡ç”¨åŠ©æˆ',
                'ä¼‘æ¥­æ‰‹å½“', 'é›‡ç”¨èª¿æ•´åŠ©æˆé‡‘', 'ä¼‘æ¥­', 'é›‡ç”¨'
            ],
            'æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘': [
                'æ¥­å‹™æ”¹å–„', 'è³ƒé‡‘å¼•ä¸Šã’', 'æœ€ä½è³ƒé‡‘', 'ç”Ÿç”£æ€§å‘ä¸Š', 'åƒãæ–¹æ”¹é©',
                'åŠ´åƒç’°å¢ƒæ”¹å–„', 'è¨­å‚™æ”¹å–„', 'è·å ´æ”¹å–„', 'è³ƒä¸Šã’',
                'åŠ´åƒæ¡ä»¶æ”¹å–„', 'æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘', 'è³ƒé‡‘', 'æœ€ä½è³ƒé‡‘'
            ],
            'å‰µæ¥­åŠ©æˆé‡‘': [
                'å‰µæ¥­', 'èµ·æ¥­', 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—', 'æ–°è¦é–‹æ¥­', 'é–‹æ¥­æ”¯æ´',
                'å‰µæ¥­æ”¯æ´', 'èµ·æ¥­åŠ©æˆ', 'æ–°è¦äº‹æ¥­', 'é–‹æ¥­åŠ©æˆ', 'å‰µæ¥­åŠ©æˆé‡‘'
            ],
            'äº‹æ¥­å†æ§‹ç¯‰è£œåŠ©é‡‘': [
                'å†æ§‹ç¯‰', 'äº‹æ¥­è»¢æ›', 'æ–°åˆ†é‡å±•é–‹', 'æ¥­æ…‹è»¢æ›', 'äº‹æ¥­å†æ§‹ç¯‰è£œåŠ©é‡‘',
                'Vå­—å›å¾©', 'äº‹æ¥­å¤‰é©', 'æ§‹é€ æ”¹é©', 'ãƒ”ãƒœãƒƒãƒˆ', 'è»¢æ›'
            ],
            'äº‹æ¥­æ‰¿ç¶™ãƒ»å¼•ç¶™ãè£œåŠ©é‡‘': [
                'äº‹æ¥­æ‰¿ç¶™', 'æ‰¿ç¶™è£œåŠ©', 'å¼•ç¶™ãè£œåŠ©é‡‘', 'å¾Œç¶™è€…æ”¯æ´'
            ],
            'å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘': [
                'æŒç¶šåŒ–', 'å°è¦æ¨¡äº‹æ¥­è€…è£œåŠ©'
            ]
        }
        
        # è³ªå•ã®æ„å›³åˆ†é¡ãƒ‘ã‚¿ãƒ¼ãƒ³
        self.intent_patterns = {
            'overview': {
                'patterns': [
                    r'è£œåŠ©é‡‘.*ã¨ã¯', r'è£œåŠ©é‡‘.*ã«ã¤ã„ã¦.*æ•™ãˆ', r'è£œåŠ©é‡‘.*ä»•çµ„ã¿',
                    r'ã©ã‚“ãª.*è£œåŠ©é‡‘', r'è£œåŠ©é‡‘.*ç¨®é¡', r'è£œåŠ©é‡‘.*æ¦‚è¦',
                    r'è£œåŠ©é‡‘.*å…¨èˆ¬', r'è£œåŠ©é‡‘.*åŸºæœ¬', r'è£œåŠ©é‡‘.*èª¬æ˜'
                ],
                'keywords': ['ã¨ã¯', 'æ•™ãˆã¦', 'èª¬æ˜', 'ä»•çµ„ã¿', 'ç¨®é¡', 'æ¦‚è¦', 'å…¨èˆ¬', 'åŸºæœ¬']
            },
            'specific_subsidy': {
                'patterns': [],  # å‹•çš„ã«ç”Ÿæˆ
                'keywords': []   # å‹•çš„ã«ç”Ÿæˆ
            },
            'application_process': {
                'patterns': [
                    r'ç”³è«‹.*æ–¹æ³•', r'ç”³è«‹.*æ‰‹é †', r'ç”³è«‹.*ã‚„ã‚Šæ–¹', r'ç”³è«‹.*æµã‚Œ',
                    r'ã©ã†.*ç”³è«‹', r'ç”³è«‹.*ã«ã¤ã„ã¦', r'ç”³è«‹.*ã—ãŸã„',
                    r'å¿…è¦.*æ›¸é¡', r'æ›¸é¡.*ä½•', r'æå‡º.*æ›¸é¡',
                    r'æœŸé™.*ã„ã¤', r'ç· åˆ‡.*ã„ã¤', r'ã„ã¤ã¾ã§.*ç”³è«‹'
                ],
                'keywords': ['ç”³è«‹', 'æ‰‹é †', 'ã‚„ã‚Šæ–¹', 'æµã‚Œ', 'æ›¸é¡', 'æœŸé™', 'ç· åˆ‡', 'æå‡º']
            },
            'requirements': {
                'patterns': [
                    r'è¦ä»¶.*ä½•', r'æ¡ä»¶.*ä½•', r'è³‡æ ¼.*ä½•', r'å¯¾è±¡.*ä½•',
                    r'ä½¿ãˆã‚‹.*ã‹', r'å¯¾è±¡.*ãªã‚‹', r'è©²å½“.*ã™ã‚‹',
                    r'ã†ã¡ã®.*ä¼šç¤¾.*å¯¾è±¡', r'å¼Šç¤¾.*å¯¾è±¡', r'å½“ç¤¾.*ä½¿ãˆã‚‹'
                ],
                'keywords': ['è¦ä»¶', 'æ¡ä»¶', 'è³‡æ ¼', 'å¯¾è±¡', 'è©²å½“', 'ä½¿ãˆã‚‹', 'é©ç”¨']
            },
            'strategy': {
                'patterns': [
                    r'æ¡æŠ.*ã•ã‚Œ.*æ–¹æ³•', r'é€šã‚Š.*ã‚„ã™ã„', r'æˆåŠŸ.*æ–¹æ³•',
                    r'æ¡æŠç‡.*ä¸Šã’', r'ç¢ºç‡.*é«˜ã‚', r'å‹ã¤.*æ–¹æ³•',
                    r'ã‚³ãƒ„.*æ•™ãˆ', r'ç§˜è¨£.*æ•™ãˆ', r'æˆ¦ç•¥.*æ•™ãˆ'
                ],
                'keywords': ['æ¡æŠ', 'æˆåŠŸ', 'ç¢ºç‡', 'ã‚³ãƒ„', 'ç§˜è¨£', 'æˆ¦ç•¥', 'å·®åˆ¥åŒ–', 'ç«¶åˆ', 'æœ‰åˆ©']
            },
            'amount_rate': {
                'patterns': [
                    r'ã„ãã‚‰.*ã‚‚ã‚‰ãˆ', r'é‡‘é¡.*ã„ãã‚‰', r'è£œåŠ©é¡.*ã„ãã‚‰',
                    r'æœ€å¤§.*ã„ãã‚‰', r'ä¸Šé™.*ã„ãã‚‰', r'é™åº¦é¡.*ã„ãã‚‰',
                    r'è£œåŠ©ç‡.*ã„ãã‚‰', r'ä½•å‰².*è£œåŠ©', r'ä½•ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ.*è£œåŠ©'
                ],
                'keywords': ['ã„ãã‚‰', 'é‡‘é¡', 'è£œåŠ©é¡', 'æœ€å¤§', 'ä¸Šé™', 'é™åº¦é¡', 'è£œåŠ©ç‡', 'ä½•å‰²', 'ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ']
            }
        }
        
        # specific_subsidy ã®å‹•çš„ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆ
        self._generate_dynamic_patterns()
        
        # æ„Ÿæƒ…ãƒ»ä¸å¯§åº¦ã®åˆ†æ
        self.tone_patterns = {
            'polite': [r'ã„ãŸã ã‘', r'ãŠèã‹ã›', r'ãŠæ•™ãˆ', r'æã‚Œå…¥ã‚Š', r'ç”³ã—è¨³', r'ã‚ˆã‚ã—ã'],
            'casual': [r'æ•™ãˆã¦', r'ã©ã†', r'ãªã«', r'ã©ã“', r'ã„ãã‚‰'],
            'urgent': [r'æ€¥ã„', r'è‡³æ€¥', r'ã™ã', r'æ—©ã', r'é–“ã«åˆã‚'],
            'confused': [r'åˆ†ã‹ã‚‰', r'ã‚ˆã.*ç†è§£', r'é›£ã—', r'è¤‡é›‘', r'æ··ä¹±']
        }

    def _generate_dynamic_patterns(self):
        """ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¾æ›¸ã‹ã‚‰å‹•çš„ã«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ"""
        patterns = []
        keywords = []
        
        for subsidy_name, aliases in self.subsidy_aliases.items():
            # æ­£å¼åç§°ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è¿½åŠ 
            escaped_name = re.escape(subsidy_name)
            patterns.append(escaped_name)
            
            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦ä¸»è¦éƒ¨åˆ†ã‚’æŠ½å‡º
            main_keywords = subsidy_name.replace('è£œåŠ©é‡‘', '').replace('åŠ©æˆé‡‘', '').split('ãƒ»')
            keywords.extend([kw.strip() for kw in main_keywords if kw.strip()])
            
            # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«è¿½åŠ 
            keywords.extend(aliases)
        
        self.intent_patterns['specific_subsidy']['patterns'] = patterns
        self.intent_patterns['specific_subsidy']['keywords'] = list(set(keywords))

    def analyze_question(self, question_text, user_context=None):
        """è‡ªç„¶è¨€èªè§£æã«ã‚ˆã‚‹è³ªå•åˆ†æï¼ˆå®Œå…¨ç‰ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹å¯¾å¿œï¼‰"""
        
        # Step 1: è³ªå•ã®æ„å›³ã‚’åˆ†æ
        intent = self._analyze_intent(question_text)
        
        # Step 2: å¯¾è±¡è£œåŠ©é‡‘ã‚’ç‰¹å®šï¼ˆæ‹¡å¼µã‚¨ã‚¤ãƒªã‚¢ã‚¹ä½¿ç”¨ï¼‰
        target_subsidy = self._identify_target_subsidy_enhanced(question_text)
        
        # Step 3: æ„Ÿæƒ…ãƒ»ä¸å¯§åº¦ã‚’åˆ†æ
        tone = self._analyze_tone(question_text)
        
        # Step 4: ãƒ“ã‚¸ãƒã‚¹æƒ…å ±ã‚’æŠ½å‡º
        business_info = self._extract_business_info(question_text, user_context)
        
        # Step 5: å›ç­”ã‚’ç”Ÿæˆ
        response = self._generate_contextual_response(
            question_text, intent, target_subsidy, tone, business_info, user_context
        )
        
        return response

    def _identify_target_subsidy_enhanced(self, question_text):
        """æ‹¡å¼µã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ç”¨ã—ãŸè£œåŠ©é‡‘ç‰¹å®šï¼ˆæ”¹è‰¯ç‰ˆï¼‰"""
        question_lower = question_text.lower()
        
        # æ­£è¦åŒ–å‡¦ç†ï¼ˆå…¨è§’â†’åŠè§’ã€è¨˜å·é™¤å»ãªã©ï¼‰
        normalized_question = self._normalize_text(question_lower)
        
        # Step 1: æ­£å¼åç§°ã§ã®å®Œå…¨ä¸€è‡´
        for subsidy in self.subsidies:
            subsidy_normalized = self._normalize_text(subsidy.name.lower())
            if subsidy_normalized in normalized_question:
                return subsidy
        
        # Step 2: ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¾æ›¸ã‚’ä½¿ç”¨ã—ãŸç‰¹å®šï¼ˆã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ï¼‰
        subsidy_scores = {}
        
        for subsidy_name, aliases in self.subsidy_aliases.items():
            score = 0
            
            # æ­£å¼åç§°ã§ã®éƒ¨åˆ†ãƒãƒƒãƒ
            main_parts = subsidy_name.replace('è£œåŠ©é‡‘', '').replace('åŠ©æˆé‡‘', '').split('ãƒ»')
            for part in main_parts:
                if part and self._normalize_text(part.lower()) in normalized_question:
                    score += 5
            
            # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§ã®ãƒãƒƒãƒ
            for alias in aliases:
                alias_normalized = self._normalize_text(alias.lower())
                if alias_normalized in normalized_question:
                    # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®é•·ã•ã«å¿œã˜ã¦ã‚¹ã‚³ã‚¢èª¿æ•´ï¼ˆé•·ã„ã»ã©é«˜ã‚¹ã‚³ã‚¢ï¼‰
                    score += max(1, len(alias_normalized) // 2)
            
            if score > 0:
                subsidy_scores[subsidy_name] = score
        
        # æœ€é«˜ã‚¹ã‚³ã‚¢ã®è£œåŠ©é‡‘ã‚’è¿”ã™
        if subsidy_scores:
            best_match = max(subsidy_scores.keys(), key=lambda x: subsidy_scores[x])
            try:
                return SubsidyType.objects.get(name=best_match)
            except SubsidyType.DoesNotExist:
                pass
        
        # Step 3: ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«ã‚ˆã‚‹æ¨å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        return self._pattern_based_identification(question_text)

    def _normalize_text(self, text):
        """ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–ï¼ˆå…¨è§’â†’åŠè§’ã€è¨˜å·é™¤å»ãªã©ï¼‰"""
        # å…¨è§’è‹±æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
        text = text.translate(str.maketrans(
            'ï¼¡ï¼¢ï¼£ï¼¤ï¼¥ï¼¦ï¼§ï¼¨ï¼©ï¼ªï¼«ï¼¬ï¼­ï¼®ï¼¯ï¼°ï¼±ï¼²ï¼³ï¼´ï¼µï¼¶ï¼·ï¼¸ï¼¹ï¼º'
            'ï½ï½‚ï½ƒï½„ï½…ï½†ï½‡ï½ˆï½‰ï½Šï½‹ï½Œï½ï½ï½ï½ï½‘ï½’ï½“ï½”ï½•ï½–ï½—ï½˜ï½™ï½š'
            'ï¼ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™',
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
            'abcdefghijklmnopqrstuvwxyz'
            '0123456789'
        ))
        
        # è¨˜å·ãƒ»ç©ºç™½ã‚’é™¤å»
        text = re.sub(r'[^\w]', '', text)
        
        return text

    def _pattern_based_identification(self, question_text):
        """ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ã®è£œåŠ©é‡‘ç‰¹å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"""
        question_lower = question_text.lower()
        normalized_question = self._normalize_text(question_lower)
        
        # ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ï¼ˆå„ªå…ˆåº¦é †ï¼‰
        patterns = [
            # ITãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«é–¢é€£
            (r'it|ï¼©ï¼´|ãƒ‡ã‚¸ã‚¿ãƒ«|ã‚·ã‚¹ãƒ†ãƒ |ã‚½ãƒ•ãƒˆ|dx', ['ITå°å…¥è£œåŠ©é‡‘', 'ITå°å…¥è£œåŠ©é‡‘2025']),
            
            # çœåŠ›åŒ–ãƒ»è‡ªå‹•åŒ–é–¢é€£
            (r'çœåŠ›åŒ–|äººæ‰‹ä¸è¶³|è‡ªå‹•åŒ–|ai|iot|ãƒ­ãƒœãƒƒãƒˆ|çœäººåŒ–|åŠ´åƒåŠ›ä¸è¶³', ['çœåŠ›åŒ–æŠ•è³‡è£œåŠ©é‡‘']),
            
            # ã‚‚ã®ã¥ãã‚Šãƒ»è£½é€ é–¢é€£
            (r'ã‚‚ã®ã¥ãã‚Š|è£½é€ |è¨­å‚™æŠ•è³‡|æ©Ÿæ¢°|å·¥å ´|ç”Ÿç”£', ['ã‚‚ã®ã¥ãã‚Šè£œåŠ©é‡‘']),
            
            # å°è¦æ¨¡äº‹æ¥­è€…é–¢é€£
            (r'å°è¦æ¨¡.*æŒç¶šåŒ–|è²©è·¯é–‹æ‹“|å°è¦æ¨¡äº‹æ¥­è€…', ['å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘ã€ä¸€èˆ¬å‹ã€‘']),
            
            # å‰µæ¥­é–¢é€£
            (r'å‰µæ¥­|èµ·æ¥­|ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—|æ–°è¦é–‹æ¥­', ['å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘ã€å‰µæ¥­å‹ã€‘', 'å‰µæ¥­åŠ©æˆé‡‘']),
            
            # äº‹æ¥­æ‰¿ç¶™é–¢é€£
            (r'äº‹æ¥­æ‰¿ç¶™|æ‰¿ç¶™|å¾Œç¶™è€…|m&a|ma|è²·å', ['äº‹æ¥­æ‰¿ç¶™ãƒ»M&Aè£œåŠ©é‡‘', 'äº‹æ¥­æ‰¿ç¶™ãƒ»å¼•ç¶™ãè£œåŠ©é‡‘']),
            
            # æ–°äº‹æ¥­é–¢é€£
            (r'æ–°äº‹æ¥­|æ–°åˆ†é‡|å¤šè§’åŒ–|äº‹æ¥­æ‹¡å¤§', ['æ–°äº‹æ¥­é€²å‡ºè£œåŠ©é‡‘']),
            
            # æˆé•·ãƒ»æ‹¡å¤§é–¢é€£
            (r'æˆé•·|æ‹¡å¤§|ã‚°ãƒ­ãƒ¼ãƒãƒ«|æµ·å¤–é€²å‡º', ['æˆé•·åŠ é€ŸåŒ–è£œåŠ©é‡‘']),
            
            # ç’°å¢ƒãƒ»çœã‚¨ãƒé–¢é€£
            (r'çœã‚¨ãƒ|ç’°å¢ƒ|è„±ç‚­ç´ |ã‚«ãƒ¼ãƒœãƒ³|co2', ['çœã‚¨ãƒè¨ºæ–­ãƒ»çœã‚¨ãƒãƒ»éåŒ–çŸ³è»¢æ›è£œåŠ©é‡‘']),
            
            # é›‡ç”¨é–¢é€£
            (r'é›‡ç”¨èª¿æ•´|é›‡èª¿é‡‘|ä¼‘æ¥­|é›‡ç”¨ç¶­æŒ', ['é›‡ç”¨èª¿æ•´åŠ©æˆé‡‘']),
            
            # æ¥­å‹™æ”¹å–„é–¢é€£
            (r'æ¥­å‹™æ”¹å–„|è³ƒé‡‘|æœ€ä½è³ƒé‡‘|åƒãæ–¹æ”¹é©', ['æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘']),
            
            # äº‹æ¥­å†æ§‹ç¯‰é–¢é€£
            (r'å†æ§‹ç¯‰|è»¢æ›|ãƒ”ãƒœãƒƒãƒˆ|æ¥­æ…‹è»¢æ›', ['äº‹æ¥­å†æ§‹ç¯‰è£œåŠ©é‡‘'])
        ]
        
        for pattern, candidate_names in patterns:
            if re.search(pattern, normalized_question):
                # å€™è£œã®ä¸­ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã™ã‚‹ã‚‚ã®ã‚’è¿”ã™
                for name in candidate_names:
                    try:
                        return SubsidyType.objects.get(name=name)
                    except SubsidyType.DoesNotExist:
                        continue
        
        return None

    def _analyze_intent(self, question_text):
        """è³ªå•ã®æ„å›³ã‚’åˆ†æ"""
        question_lower = question_text.lower()
        intent_scores = {}
        
        # è£œåŠ©é‡‘ãŒç‰¹å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        has_specific_subsidy = self._identify_target_subsidy_enhanced(question_text) is not None
        
        for intent_type, config in self.intent_patterns.items():
            score = 0
            
            # ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
            for pattern in config['patterns']:
                if re.search(pattern, question_text):
                    score += 3
            
            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
            for keyword in config['keywords']:
                if keyword.lower() in question_lower:
                    score += 1
            
            intent_scores[intent_type] = score
        
        # ç‰¹å®šã®è£œåŠ©é‡‘ãŒè­˜åˆ¥ã•ã‚ŒãŸå ´åˆã®é‡ã¿èª¿æ•´
        if has_specific_subsidy:
            intent_scores['specific_subsidy'] += 5
            
            if re.search(r'ã«ã¤ã„ã¦.*æ•™ãˆ|ã‚’.*æ•™ãˆ|ã®.*è©³ç´°|è©³ã—ã', question_text):
                intent_scores['specific_subsidy'] += 10
        
        # æœ€é«˜ã‚¹ã‚³ã‚¢ã®æ„å›³ã‚’è¿”ã™
        if intent_scores:
            primary_intent = max(intent_scores.keys(), key=lambda x: intent_scores[x])
            
            if intent_scores[primary_intent] == 0:
                primary_intent = 'specific_subsidy' if has_specific_subsidy else 'overview'
            
            confidence = intent_scores[primary_intent] / max(sum(intent_scores.values()), 1)
            secondary_intents = [k for k, v in intent_scores.items() 
                               if v > 0 and k != primary_intent]
            
            return {
                'primary': primary_intent,
                'secondary': secondary_intents,
                'confidence': confidence,
                'scores': intent_scores
            }
        
        return {'primary': 'overview', 'secondary': [], 'confidence': 0.5, 'scores': {}}

    def _analyze_tone(self, question_text):
        """æ„Ÿæƒ…ãƒ»ä¸å¯§åº¦ã‚’åˆ†æ"""
        tone_scores = {}
        
        for tone_type, patterns in self.tone_patterns.items():
            score = sum(1 for pattern in patterns if re.search(pattern, question_text))
            if score > 0:
                tone_scores[tone_type] = score
        
        primary_tone = max(tone_scores.keys(), key=lambda x: tone_scores[x]) if tone_scores else 'neutral'
        
        return {
            'primary': primary_tone,
            'is_polite': 'polite' in tone_scores,
            'is_urgent': 'urgent' in tone_scores,
            'is_confused': 'confused' in tone_scores,
            'scores': tone_scores
        }

    def _extract_business_info(self, question_text, user_context):
        """ãƒ“ã‚¸ãƒã‚¹æƒ…å ±ã‚’æŠ½å‡º"""
        business_info = {}
        question_lower = question_text.lower()
        
        # æ¥­ç¨®ã®ç‰¹å®š
        industry_keywords = {
            'è£½é€ æ¥­': ['è£½é€ ', 'å·¥å ´', 'ç”Ÿç”£', 'ãƒ¡ãƒ¼ã‚«ãƒ¼', 'æ©Ÿæ¢°'],
            'ITãƒ»æƒ…å ±é€šä¿¡æ¥­': ['it', 'ã‚·ã‚¹ãƒ†ãƒ ', 'ã‚½ãƒ•ãƒˆ', 'web', 'ã‚¢ãƒ—ãƒª'],
            'ã‚µãƒ¼ãƒ“ã‚¹æ¥­': ['ã‚µãƒ¼ãƒ“ã‚¹', 'ã‚³ãƒ³ã‚µãƒ«', 'å£«æ¥­'],
            'å°å£²æ¥­': ['å°å£²', 'è²©å£²', 'åº—èˆ—', 'ec'],
            'å»ºè¨­æ¥­': ['å»ºè¨­', 'å·¥äº‹', 'æ–½å·¥'],
            'é£²é£Ÿæ¥­': ['é£²é£Ÿ', 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', 'ã‚«ãƒ•ã‚§']
        }
        
        for industry, keywords in industry_keywords.items():
            if any(keyword in question_lower for keyword in keywords):
                business_info['business_type'] = industry
                break
        
        return business_info

    def _generate_contextual_response(self, question_text, intent, target_subsidy, tone, business_info, user_context):
        """æ–‡è„ˆã«å¿œã˜ãŸå›ç­”ç”Ÿæˆ"""
        
        is_polite = tone['is_polite']
        is_urgent = tone['is_urgent']
        primary_intent = intent['primary']
        
        if primary_intent == 'specific_subsidy' and target_subsidy:
            return self._generate_specific_subsidy_response(target_subsidy, is_polite, is_urgent, business_info)
        elif primary_intent == 'overview':
            return self._generate_overview_response(is_polite, business_info)
        elif primary_intent == 'strategy':
            return self._generate_strategy_response(target_subsidy, is_polite, business_info)
        else:
            return self._generate_general_response(question_text, intent, is_polite, business_info)

    def _generate_specific_subsidy_response(self, subsidy, is_polite, is_urgent, business_info):
        """ç‰¹å®šè£œåŠ©é‡‘ã®è©³ç´°å›ç­”"""
        greeting = "æã‚Œå…¥ã‚Šã¾ã™ã€‚" if is_polite else ""
        urgency_note = "\n\nâš¡ **ãŠæ€¥ãã®å ´åˆ**: ã¾ãšã¯ç”³è«‹æœŸé™ã‚’ã”ç¢ºèªãã ã•ã„ã€‚" if is_urgent else ""
        
        response = f"""{greeting}

## ğŸ“‹ {subsidy.name} ã«ã¤ã„ã¦è©³ã—ãã”èª¬æ˜ã—ã¾ã™

### ğŸ¯ æ¦‚è¦
{subsidy.description}

### ğŸ’° è£œåŠ©é‡‘é¡
- **æœ€å¤§è£œåŠ©é¡**: {subsidy.max_amount}ä¸‡å††

### ğŸ‘¥ å¯¾è±¡äº‹æ¥­è€…
{subsidy.target_business_type}

### âœ… ä¸»ãªç”³è«‹è¦ä»¶
{subsidy.requirements}

### ğŸ“… æº–å‚™æœŸé–“ã®ç›®å®‰
- **å¹³å‡æº–å‚™æœŸé–“**: {subsidy.average_preparation_weeks}é€±
- **ç”³è«‹é›£æ˜“åº¦**: {'â­' * subsidy.application_difficulty}
- **éå»ã®æ¡æŠç‡**: {int(subsidy.historical_success_rate * 100)}%

## ğŸ“ ç”³è«‹ã®æµã‚Œ

### **STEP 1: äº‹å‰æº–å‚™ï¼ˆ2-3ãƒ¶æœˆå‰ï¼‰**
1. **è¦ä»¶ç¢ºèª**: è©³ç´°ãªç”³è«‹è¦ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
2. **æ›¸é¡æº–å‚™**: å¿…è¦æ›¸é¡ã®ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã¨åé›†é–‹å§‹
3. **è¨ˆç”»æ¤œè¨**: äº‹æ¥­è¨ˆç”»ã®éª¨å­ä½œæˆ

### **STEP 2: ç”³è«‹æ›¸ä½œæˆï¼ˆç”³è«‹1ãƒ¶æœˆå‰ï¼‰**
1. **äº‹æ¥­è¨ˆç”»æ›¸**: å…·ä½“çš„ã§å®Ÿç¾å¯èƒ½ãªè¨ˆç”»ã‚’ä½œæˆ
2. **è¦‹ç©æ›¸å–å¾—**: è¤‡æ•°ç¤¾ã‹ã‚‰è©³ç´°è¦‹ç©ã‚‚ã‚Šã‚’å–å¾—
3. **è¨¼æ†‘æ›¸é¡**: æ±ºç®—æ›¸ã€ç¨å‹™ç”³å‘Šæ›¸ç­‰ã‚’æ•´ç†

### **STEP 3: ç”³è«‹æå‡º**
1. **æœ€çµ‚ç¢ºèª**: ç”³è«‹æ›¸é¡ã®å®Œå…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯
2. **é›»å­ç”³è«‹**: æŒ‡å®šã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æå‡º
3. **å—ä»˜ç¢ºèª**: æå‡ºå®Œäº†ã®ç¢ºèª

{urgency_note}

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ï¼"""

        return {
            'answer': response,
            'recommended_subsidies': [subsidy],
            'confidence_score': 0.95,
            'model_used': 'nlp-enhanced'
        }

    def _generate_overview_response(self, is_polite, business_info):
        """æ¦‚è¦å›ç­”ã®ç”Ÿæˆ"""
        greeting = "ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚" if is_polite else ""
        
        response = f"""{greeting}

## ğŸ¯ è£œåŠ©é‡‘åˆ¶åº¦ã«ã¤ã„ã¦ç·åˆçš„ã«ã”èª¬æ˜ã—ã¾ã™

### ğŸ’¡ ä¸»è¦ãªè£œåŠ©é‡‘ã®ç¨®é¡

#### **ğŸ–¥ï¸ ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–æ”¯æ´**
- **ITå°å…¥è£œåŠ©é‡‘**: ITãƒ„ãƒ¼ãƒ«å°å…¥ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–
- **çœåŠ›åŒ–æŠ•è³‡è£œåŠ©é‡‘**: AIãƒ»IoTãƒ»ãƒ­ãƒœãƒƒãƒˆå°å…¥æ”¯æ´

#### **ğŸ­ äº‹æ¥­å¼·åŒ–æ”¯æ´**
- **ã‚‚ã®ã¥ãã‚Šè£œåŠ©é‡‘**: è¨­å‚™æŠ•è³‡ãƒ»é©æ–°çš„ã‚µãƒ¼ãƒ“ã‚¹é–‹ç™º
- **äº‹æ¥­å†æ§‹ç¯‰è£œåŠ©é‡‘**: æ–°åˆ†é‡å±•é–‹ãƒ»æ¥­æ…‹è»¢æ›

#### **ğŸ¢ å°è¦æ¨¡äº‹æ¥­è€…æ”¯æ´**
- **æŒç¶šåŒ–è£œåŠ©é‡‘ï¼ˆä¸€èˆ¬å‹ï¼‰**: è²©è·¯é–‹æ‹“ãƒ»èªçŸ¥åº¦å‘ä¸Š
- **æŒç¶šåŒ–è£œåŠ©é‡‘ï¼ˆå‰µæ¥­å‹ï¼‰**: å‰µæ¥­æœŸã®äº‹æ¥­æ‹¡å¤§æ”¯æ´

#### **âš¡ ãã®ä»–ã®é‡è¦åˆ¶åº¦**
- **é›‡ç”¨èª¿æ•´åŠ©æˆé‡‘**: é›‡ç”¨ç¶­æŒæ”¯æ´
- **æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘**: è³ƒé‡‘å‘ä¸Šãƒ»åƒãæ–¹æ”¹é©
- **äº‹æ¥­æ‰¿ç¶™ãƒ»M&Aè£œåŠ©é‡‘**: äº‹æ¥­æ‰¿ç¶™æ”¯æ´

### ğŸ¯ é¸æŠã®ãƒã‚¤ãƒ³ãƒˆ

1. **äº‹æ¥­è¦æ¨¡**: å°è¦æ¨¡äº‹æ¥­è€… vs ä¸­å°ä¼æ¥­
2. **ç›®çš„**: ãƒ‡ã‚¸ã‚¿ãƒ«åŒ– vs äº‹æ¥­æ‹¡å¤§ vs æ‰¿ç¶™ãƒ»è»¢æ›
3. **æŠ•è³‡è¦æ¨¡**: 50ä¸‡å††ï½1,000ä¸‡å††ä»¥ä¸Š
4. **æº–å‚™æœŸé–“**: 4é€±ï½14é€±

### ğŸ“‹ åŸºæœ¬çš„ãªç”³è«‹ã®æµã‚Œ

1. **è£œåŠ©é‡‘ã®é¸æŠ**
2. **è¦ä»¶ç¢ºèª**
3. **äº‹æ¥­è¨ˆç”»ä½œæˆ**
4. **ç”³è«‹æ›¸æå‡º**
5. **å¯©æŸ»ãƒ»æ¡æŠ**
6. **äº‹æ¥­å®Ÿæ–½**

ã©ã®è£œåŠ©é‡‘ãŒæœ€é©ã‹ã€å…·ä½“çš„ã«ã”ç›¸è«‡ã„ãŸã ã‘ã¾ã—ãŸã‚‰è©³ã—ãã‚¢ãƒ‰ãƒã‚¤ã‚¹ã„ãŸã—ã¾ã™ï¼"""

        return {
            'answer': response,
            'recommended_subsidies': list(self.subsidies[:3]),
            'confidence_score': 0.8,
            'model_used': 'nlp-overview'
        }

    def _generate_strategy_response(self, target_subsidy, is_polite, business_info):
        """æˆ¦ç•¥çš„å›ç­”ã®ç”Ÿæˆ"""
        subsidy_name = target_subsidy.name if target_subsidy else "è£œåŠ©é‡‘"
        
        response = f"""## ğŸ¯ {subsidy_name} æ¡æŠæˆ¦ç•¥

### ğŸ“Š æˆåŠŸã®ãŸã‚ã®3ã¤ã®æˆ¦ç•¥

#### **æˆ¦ç•¥â‘  æ—©æœŸç”³è«‹ã«ã‚ˆã‚‹å„ªä½æ€§ç¢ºä¿**
- å…¬å‹Ÿé–‹å§‹ã‹ã‚‰2é€±é–“ä»¥å†…ã®ç”³è«‹ã‚’ç›®æŒ‡ã™
- å¯©æŸ»å“¡ã®é›†ä¸­åŠ›ãŒé«˜ã„æ™‚æœŸã‚’æ´»ç”¨
- **åŠ¹æœ**: æ¡æŠç‡+15%å‘ä¸Š

#### **æˆ¦ç•¥â‘¡ å·®åˆ¥åŒ–ã«ã‚ˆã‚‹ç‹¬è‡ªæ€§ã‚¢ãƒ”ãƒ¼ãƒ«**
- ç«¶åˆä»–ç¤¾ã«ãªã„ç‹¬è‡ªã®å¼·ã¿ã‚’æ˜ç¢ºåŒ–
- å…·ä½“çš„ãªæˆæœæŒ‡æ¨™ã¨æ ¹æ‹ ã‚’æç¤º
- **åŠ¹æœ**: å°è±¡åº¦å¤§å¹…ã‚¢ãƒƒãƒ—

#### **æˆ¦ç•¥â‘¢ æ•°å€¤åŒ–ã«ã‚ˆã‚‹èª¬å¾—åŠ›å¼·åŒ–**
- ã€Œå£²ä¸Š30%å‘ä¸Šã€ãªã©å…·ä½“çš„ç›®æ¨™è¨­å®š
- ROIï¼ˆæŠ•è³‡å¯¾åŠ¹æœï¼‰ã®æ˜ç¢ºåŒ–
- **åŠ¹æœ**: å¯©æŸ»å“¡ã®ç´å¾—åº¦å‘ä¸Š

### ğŸš€ ä»Šã™ãå§‹ã‚ã‚‹5ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. âœ… **ç«¶åˆåˆ†æ**: åŒæ¥­ä»–ç¤¾ã®ç”³è«‹å‹•å‘èª¿æŸ»
2. âœ… **å°‚é–€å®¶é¸å®š**: æ¡æŠå®Ÿç¸¾è±Šå¯Œãªæ”¯æ´æ©Ÿé–¢ã¨ã®é€£æº
3. âœ… **å¼·ã¿ã®æ˜ç¢ºåŒ–**: è‡ªç¤¾ã®ç‹¬è‡ªæ€§ãƒ»å„ªä½æ€§ã®æ•´ç†
4. âœ… **æ•°å€¤ç›®æ¨™è¨­å®š**: å…·ä½“çš„ã§å®Ÿç¾å¯èƒ½ãªæ”¹å–„æŒ‡æ¨™
5. âœ… **ãƒªã‚¹ã‚¯å¯¾ç­–**: ç”³è«‹å¤±æ•—æ™‚ã®ãƒ—ãƒ©ãƒ³Bç­–å®š

æˆ¦ç•¥çš„ã«é€²ã‚ã‚‹ã“ã¨ã§ã€æ¡æŠç¢ºç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼"""

        return {
            'answer': response,
            'recommended_subsidies': [target_subsidy] if target_subsidy else [],
            'confidence_score': 0.9,
            'model_used': 'nlp-strategy'
        }

    def _generate_general_response(self, question_text, intent, is_polite, business_info):
        """ä¸€èˆ¬çš„ãªå›ç­”ã®ç”Ÿæˆ"""
        greeting = "ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚" if is_polite else ""
        
        response = f"""{greeting}

ã”è³ªå•ã®å†…å®¹ã‚’æ‹è¦‹ã—ã€æœ€é©ãªè£œåŠ©é‡‘åˆ¶åº¦ã‚’ã”ææ¡ˆã„ãŸã—ã¾ã™ã€‚

### ğŸ” çŠ¶æ³ã«å¿œã˜ãŸæ¨å¥¨è£œåŠ©é‡‘

ç¾åœ¨ã®ã”çŠ¶æ³ã‚„ãƒ‹ãƒ¼ã‚ºã«åˆã‚ã›ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè£œåŠ©é‡‘åˆ¶åº¦ãŒã”ã–ã„ã¾ã™ï¼š

- **ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã‚’ãŠè€ƒãˆã®å ´åˆ**: ITå°å…¥è£œåŠ©é‡‘ã€çœåŠ›åŒ–æŠ•è³‡è£œåŠ©é‡‘
- **è¨­å‚™æŠ•è³‡ã‚’ã”æ¤œè¨ã®å ´åˆ**: ã‚‚ã®ã¥ãã‚Šè£œåŠ©é‡‘ã€çœåŠ›åŒ–æŠ•è³‡è£œåŠ©é‡‘
- **è²©è·¯æ‹¡å¤§ã‚’ãŠè€ƒãˆã®å ´åˆ**: å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘
- **æ–°äº‹æ¥­å±•é–‹ã‚’ãŠè€ƒãˆã®å ´åˆ**: æ–°äº‹æ¥­é€²å‡ºè£œåŠ©é‡‘ã€æˆé•·åŠ é€ŸåŒ–è£œåŠ©é‡‘

### ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚ˆã‚Šå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã”æä¾›ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ç‚¹ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã›ã‚“ã§ã—ã‚‡ã†ã‹ï¼š

1. **æ¥­ç¨®ãƒ»äº‹æ¥­å†…å®¹**
2. **è§£æ±ºã—ãŸã„èª²é¡Œ**
3. **æŠ•è³‡äºˆå®šé¡ã®è¦æ¨¡**
4. **å®Ÿç¾ã—ãŸã„ç›®æ¨™**

ã“ã‚Œã‚‰ã®æƒ…å ±ã‚’ãŠèã‹ã›ã„ãŸã ã‘ã‚Œã°ã€æœ€é©ãªè£œåŠ©é‡‘ã¨ç”³è«‹æˆ¦ç•¥ã‚’ã”ææ¡ˆã„ãŸã—ã¾ã™ï¼"""

        return {
            'answer': response,
            'recommended_subsidies': [],
            'confidence_score': 0.7,
            'model_used': 'nlp-general'
        }


# ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦è¨­å®š
AIAdvisorService = NLPAIAdvisorService