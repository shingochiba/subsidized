{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
/* ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°æ”¹å–„ */
.chat-container {
    height: 500px;
    overflow-y: auto;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
}

.chat-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    z-index: 1;
}

.chat-container > * {
    position: relative;
    z-index: 2;
}

/* ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.welcome-message {
    text-align: center;
    padding: 40px 20px;
    background: rgba(76, 175, 80, 0.1);
    border-radius: 12px;
    border: 2px dashed #4caf50;
    margin-bottom: 20px;
}

.welcome-message i {
    font-size: 3rem;
    color: #4caf50;
    margin-bottom: 16px;
    display: block;
}

.welcome-message h5 {
    color: #2e7d32;
    font-weight: 600;
    margin-bottom: 12px;
}

.welcome-message p {
    color: #388e3c;
    font-style: italic;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.user-message .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 18px 18px 6px 18px;
    padding: 16px 20px;
    max-width: 75%;
    margin-left: auto;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    border: none;
}

/* ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.assistant-message .message-bubble {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    color: #2d3748;
    border-radius: 18px 18px 18px 6px;
    padding: 20px 24px;
    max-width: 85%;
    margin-right: auto;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    border: 2px solid #e2e8f0;
}

.assistant-message .message-bubble .assistant-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e2e8f0;
}

.assistant-message .message-bubble .assistant-header .robot-icon {
    font-size: 1.2rem;
    margin-right: 8px;
    color: #4299e1;
}

.assistant-message .message-bubble .assistant-header strong {
    color: #2d3748;
    font-weight: 600;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.message-content {
    line-height: 1.6;
}

.message-content h5 {
    color: #2b6cb0;
    font-weight: 600;
    margin: 16px 0 8px 0;
    padding-left: 12px;
    border-left: 4px solid #4299e1;
}

.message-content h6 {
    color: #2d3748;
    font-weight: 600;
    margin: 12px 0 6px 0;
}

.message-content ul {
    margin: 12px 0;
    padding-left: 20px;
}

.message-content li {
    margin: 6px 0;
    color: #4a5568;
}

.message-content strong {
    color: #2d3748;
    font-weight: 600;
}

/* ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.message-time {
    font-size: 0.75rem;
    margin-top: 8px;
    opacity: 0.7;
}

.user-message .message-time {
    color: rgba(255, 255, 255, 0.8);
}

.assistant-message .message-time {
    color: #718096;
}

/* æ¨å¥¨è£œåŠ©é‡‘ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.subsidy-card {
    background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    border: 2px solid #feb2b2;
    border-radius: 12px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.subsidy-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(254, 178, 178, 0.4);
}

.subsidy-card .card-title {
    color: #c53030;
    font-weight: 600;
}

/* ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
#debugInfo {
    background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
    border: 2px solid #90cdf4;
    border-radius: 12px;
    margin-bottom: 20px;
}

#debugInfo h6 {
    color: #2c5282;
    margin-bottom: 12px;
}

#debugInfo pre {
    background: #1a202c;
    color: #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    font-size: 11px;
    max-height: 200px;
    overflow-y: auto;
}

/* å…¥åŠ›ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.input-section {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

#questionInput {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 12px 16px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#questionInput:focus {
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    outline: none;
}

#sendButton {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.2s ease;
}

#sendButton:hover {
    background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
}

/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.sidebar {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.sidebar h5, .sidebar h6 {
    color: #2d3748;
    margin-bottom: 16px;
}

.sidebar i {
    margin-right: 8px;
    color: #4299e1;
}

/* ã‚¯ã‚¤ãƒƒã‚¯è³ªå•ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.quick-question {
    background: rgba(66, 153, 225, 0.05);
    border: 1px solid rgba(66, 153, 225, 0.2);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.quick-question:hover {
    background: rgba(66, 153, 225, 0.1);
    border-color: #4299e1;
    transform: translateX(4px);
}

.quick-question i {
    color: #4299e1;
    margin-right: 8px;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
.chat-container::-webkit-scrollbar {
    width: 8px;
}

.chat-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-bubble {
    animation: fadeInUp 0.3s ease-out;
}

/* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
#typingIndicator {
    text-align: center;
    padding: 16px;
    background: rgba(66, 153, 225, 0.1);
    border-radius: 12px;
    margin-top: 12px;
    border: 1px solid rgba(66, 153, 225, 0.2);
}

#typingIndicator .spinner-border {
    color: #4299e1;
}
</style>

<div class="row">
    <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="col-lg-8">
        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="debugInfo" class="alert" style="display: none;">
            <h6>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h6>
            <div id="debugContent"></div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <i class="fas fa-robot"></i>
                <h5>è£œåŠ©é‡‘ã«ã¤ã„ã¦ä½•ã§ã‚‚ãŠèããã ã•ã„</h5>
                <p class="mb-0">ä¾‹ï¼šã€ŒITå°å…¥è£œåŠ©é‡‘ã‚’ç”³è«‹ã—ãŸã„ã®ã§ã™ãŒã€ã©ã®ã‚ˆã†ãªæº–å‚™ãŒå¿…è¦ã§ã™ã‹ï¼Ÿã€</p>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­ã§ã™...
        </div>

        <div class="input-section mt-3">
            <form id="questionForm">
                <div class="row g-2">
                    <div class="col">
                        <textarea 
                            class="form-control" 
                            id="questionInput" 
                            placeholder="è£œåŠ©é‡‘ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„..."
                            rows="2"
                            style="resize: none;"
                            required
                        ></textarea>
                    </div>
                    <div class="col-auto">
                        <button 
                            type="submit" 
                            class="btn btn-primary h-100 px-4"
                            id="sendButton"
                        >
                            <i class="fas fa-paper-plane"></i>
                            é€ä¿¡
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ -->
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-info" onclick="toggleDebug()">
                    <i class="fas fa-bug"></i> ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="testAPI()">
                    <i class="fas fa-flask"></i> API ãƒ†ã‚¹ãƒˆ
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="col-lg-4">
        <div class="sidebar">
            <h5><i class="fas fa-user-cog"></i> äº‹æ¥­æƒ…å ±</h5>
            <div class="context-form">
                <div class="mb-3">
                    <label for="businessType" class="form-label">äº‹æ¥­ç¨®åˆ¥</label>
                    <select class="form-select" id="businessType">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="è£½é€ æ¥­">è£½é€ æ¥­</option>
                        <option value="å»ºè¨­æ¥­">å»ºè¨­æ¥­</option>
                        <option value="é‹è¼¸æ¥­">é‹è¼¸æ¥­</option>
                        <option value="å¸å£²æ¥­">å¸å£²æ¥­</option>
                        <option value="å°å£²æ¥­">å°å£²æ¥­</option>
                        <option value="ã‚µãƒ¼ãƒ“ã‚¹æ¥­">ã‚µãƒ¼ãƒ“ã‚¹æ¥­</option>
                        <option value="ITãƒ»æƒ…å ±é€šä¿¡æ¥­">ITãƒ»æƒ…å ±é€šä¿¡æ¥­</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="companySize" class="form-label">ä¼æ¥­è¦æ¨¡</label>
                    <select class="form-select" id="companySize">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å°è¦æ¨¡äº‹æ¥­è€…">å°è¦æ¨¡äº‹æ¥­è€…ï¼ˆå¾“æ¥­å“¡20äººä»¥ä¸‹ï¼‰</option>
                        <option value="ä¸­å°ä¼æ¥­">ä¸­å°ä¼æ¥­</option>
                        <option value="ä¸­å …ä¼æ¥­">ä¸­å …ä¼æ¥­</option>
                        <option value="å¤§ä¼æ¥­">å¤§ä¼æ¥­</option>
                    </select>
                </div>
                <small class="text-muted">
                    äº‹æ¥­æƒ…å ±ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚ˆã‚Šé©åˆ‡ãªè£œåŠ©é‡‘ã‚’ã”ææ¡ˆã§ãã¾ã™
                </small>
            </div>

            <h6 class="mt-4"><i class="fas fa-list"></i> ã‚ˆãã‚ã‚‹è³ªå•</h6>
            <div class="list-group list-group-flush">
                <button class="list-group-item list-group-item-action quick-question" 
                        data-question="ITå°å…¥è£œåŠ©é‡‘ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„">
                    <i class="fas fa-laptop-code"></i> ITå°å…¥è£œåŠ©é‡‘ã«ã¤ã„ã¦
                </button>
                <button class="list-group-item list-group-item-action quick-question" 
                        data-question="ã‚‚ã®ã¥ãã‚Šè£œåŠ©é‡‘ã®ç”³è«‹æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„">
                    <i class="fas fa-cogs"></i> ã‚‚ã®ã¥ãã‚Šè£œåŠ©é‡‘ã®ç”³è«‹æ–¹æ³•
                </button>
                <button class="list-group-item list-group-item-action quick-question" 
                        data-question="äº‹æ¥­å†æ§‹ç¯‰è£œåŠ©é‡‘ã®ç”³è«‹æ¡ä»¶ã‚’æ•™ãˆã¦ãã ã•ã„">
                    <i class="fas fa-sync-alt"></i> äº‹æ¥­å†æ§‹ç¯‰è£œåŠ©é‡‘ã®æ¡ä»¶
                </button>
                <button class="list-group-item list-group-item-action quick-question" 
                        data-question="å°è¦æ¨¡äº‹æ¥­è€…æŒç¶šåŒ–è£œåŠ©é‡‘ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„">
                    <i class="fas fa-store"></i> æŒç¶šåŒ–è£œåŠ©é‡‘ã«ã¤ã„ã¦
                </button>
            </div>
        </div>

        <!-- æ¨å¥¨è£œåŠ©é‡‘è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="sidebar" id="recommendedSubsidies" style="display: none;">
            <h6><i class="fas fa-star text-warning"></i> æ¨å¥¨è£œåŠ©é‡‘</h6>
            <div id="subsidyList"></div>
        </div>
    </div>
</div>

<script>
console.log('ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’åˆæœŸåŒ–ä¸­...');

let chatSessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let messageHistory = [];
let lastResponse = null;

// ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
function toggleDebug() {
    const debugInfo = document.getElementById('debugInfo');
    const debugContent = document.getElementById('debugContent');
    
    if (debugInfo.style.display === 'none') {
        debugInfo.style.display = 'block';
        updateDebugInfo();
    } else {
        debugInfo.style.display = 'none';
    }
}

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
function updateDebugInfo() {
    const debugContent = document.getElementById('debugContent');
    debugContent.innerHTML = `
        <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:</strong> ${chatSessionId}<br>
        <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´:</strong> ${messageHistory.length}ä»¶<br>
        <strong>æœ€æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹:</strong><br>
        <pre>${JSON.stringify(lastResponse, null, 2)}</pre>
    `;
}

// APIç›´æ¥ãƒ†ã‚¹ãƒˆ
function testAPI() {
    console.log('APIãƒ†ã‚¹ãƒˆé–‹å§‹');
    
    const testData = {
        question: 'ãƒ†ã‚¹ãƒˆè³ªå•',
        session_id: chatSessionId,
        business_type: 'ITãƒ»æƒ…å ±é€šä¿¡æ¥­',
        company_size: 'ä¸­å°ä¼æ¥­'
    };
    
    fetch('/api/question/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: JSON.stringify(testData)
    })
    .then(response => {
        console.log('ãƒ†ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:', data);
        lastResponse = data;
        updateDebugInfo();
        alert('APIãƒ†ã‚¹ãƒˆå®Œäº†ã€‚ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    })
    .catch(error => {
        console.error('APIãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('APIãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†');
    
    // è¦ç´ ã®å–å¾—
    const chatContainer = document.getElementById('chatContainer');
    const questionInput = document.getElementById('questionInput');
    const sendButton = document.getElementById('sendButton');
    const questionForm = document.getElementById('questionForm');
    const typingIndicator = document.getElementById('typingIndicator');
    
    console.log('è¦ç´ ç¢ºèª:');
    console.log('chatContainer:', chatContainer ? 'OK' : 'NG');
    console.log('questionInput:', questionInput ? 'OK' : 'NG');
    console.log('sendButton:', sendButton ? 'OK' : 'NG');
    console.log('questionForm:', questionForm ? 'OK' : 'NG');
    
    if (!chatContainer || !questionInput || !sendButton || !questionForm) {
        console.error('å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
    questionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡');
        sendMessage();
    });
    
    // ã‚¯ã‚¤ãƒƒã‚¯è³ªå•ãƒœã‚¿ãƒ³
    document.querySelectorAll('.quick-question').forEach(button => {
        button.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            if (question) {
                questionInput.value = question;
                sendMessage();
            }
        });
    });
    
    console.log('ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–å®Œäº†');
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°
    function sendMessage() {
        console.log('sendMessageé–‹å§‹');
        
        const message = questionInput.value.trim();
        if (!message) {
            console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©º');
            return;
        }
        
        console.log('é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', message);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        addMessage('user', message);
        
        // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        questionInput.value = '';
        
        // é€ä¿¡ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
        sendButton.disabled = true;
        sendButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> é€ä¿¡ä¸­...';
        
        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        typingIndicator.style.display = 'block';
        
        // APIå‘¼ã³å‡ºã—
        callAPI(message);
    }
    
    // APIå‘¼ã³å‡ºã—é–¢æ•°
    function callAPI(message) {
        console.log('APIå‘¼ã³å‡ºã—é–‹å§‹');
        
        const businessType = document.getElementById('businessType')?.value || '';
        const companySize = document.getElementById('companySize')?.value || '';
        
        const requestData = {
            question: message,
            session_id: chatSessionId,
            business_type: businessType,
            company_size: companySize
        };
        
        console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:', requestData);
        
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
        const csrfToken = getCookie('csrftoken') || '';
        console.log('CSRFãƒˆãƒ¼ã‚¯ãƒ³:', csrfToken ? 'å–å¾—æ¸ˆã¿' : 'æœªå–å¾—');
        
        fetch('/api/question/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', data);
            lastResponse = data;
            
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼éè¡¨ç¤º
            typingIndicator.style.display = 'none';
            
            // é€ä¿¡ãƒœã‚¿ãƒ³å¾©æ´»
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> é€ä¿¡';
            
            if (data.success) {
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã«å¯¾å¿œ
                const answer = data.result?.answer || data.answer || 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã§ã™';
                const subsidies = data.result?.recommended_subsidies || data.recommended_subsidies || [];
                
                addMessage('assistant', answer);
                
                // æ¨å¥¨è£œåŠ©é‡‘è¡¨ç¤º
                if (subsidies && subsidies.length > 0) {
                    showRecommendedSubsidies(subsidies);
                }
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
                updateDebugInfo();
            } else {
                console.error('APIã‚¨ãƒ©ãƒ¼è©³ç´°:', data);
                addMessage('assistant', `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n**è©³ç´°:** ${data.error || 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼'}\n\n**ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„**`);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
                updateDebugInfo();
            }
        })
        .catch(error => {
            console.error('APIã‚¨ãƒ©ãƒ¼:', error);
            lastResponse = { error: error.message, stack: error.stack };
            
            typingIndicator.style.display = 'none';
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> é€ä¿¡';
            
            addMessage('assistant', `ğŸ”Œ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n**ã‚¨ãƒ©ãƒ¼:** ${error.message}\n\n**ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„**`);
            
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
            updateDebugInfo();
        });
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ é–¢æ•°ï¼ˆã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°æ”¹å–„ç‰ˆï¼‰
    function addMessage(sender, content) {
        console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ :', sender, content?.substring(0, 50));
        
        // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const welcomeMessage = chatContainer.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-4 ${sender}-message`;
        
        const timeStamp = new Date().toLocaleTimeString('ja-JP', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        // å®‰å…¨ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‡¦ç†
        let safeContent = '';
        if (content !== null && content !== undefined) {
            safeContent = String(content)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^## (.*$)/gm, '<h5 class="text-primary mt-3 mb-2">$1</h5>')
                .replace(/^### (.*$)/gm, '<h6 class="mt-2 mb-1">$1</h6>')
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/\n/g, '<br>');
            
            if (safeContent.includes('<li>')) {
                safeContent = safeContent.replace(/(<li>.*?<\/li>)/gs, '<ul class="mt-2">$1</ul>');
            }
        } else {
            safeContent = '<em>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç©ºã§ã™</em>';
        }
        
        if (sender === 'user') {
            messageDiv.innerHTML = `
                <div class="d-flex justify-content-end">
                    <div class="message-bubble">
                        <div class="message-content">${safeContent}</div>
                        <div class="message-time">${timeStamp}</div>
                    </div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="d-flex justify-content-start">
                    <div class="message-bubble">
                        <div class="assistant-header">
                            <span class="robot-icon">ğŸ¤–</span>
                            <strong>AI ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</strong>
                        </div>
                        <div class="message-content">${safeContent}</div>
                        <div class="message-time">${timeStamp}</div>
                    </div>
                </div>
            `;
        }
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        messageHistory.push({
            sender: sender,
            content: content,
            timestamp: new Date().toISOString()
        });
    }
    
    // æ¨å¥¨è£œåŠ©é‡‘è¡¨ç¤º
    function showRecommendedSubsidies(subsidies) {
        const subsidyList = document.getElementById('subsidyList');
        const recommendedSubsidies = document.getElementById('recommendedSubsidies');
        
        if (!subsidyList || !recommendedSubsidies) return;
        
        subsidyList.innerHTML = '';
        
        subsidies.forEach(subsidy => {
            const subsidyCard = document.createElement('div');
            subsidyCard.className = 'card mb-2 subsidy-card';
            subsidyCard.innerHTML = `
                <div class="card-body p-3">
                    <h6 class="card-title">${escapeHtml(subsidy.name || '')}</h6>
                    <p class="card-text small">
                        <strong>å¯¾è±¡:</strong> ${escapeHtml(subsidy.target_business_type || subsidy.target_business || '')}<br>
                        <strong>æœ€å¤§é‡‘é¡:</strong> ${subsidy.max_amount || 0}ä¸‡å††
                    </p>
                </div>
            `;
            subsidyList.appendChild(subsidyCard);
        });
        
        recommendedSubsidies.style.display = 'block';
    }
    
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }
    
    // Cookieå–å¾—
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

console.log('ãƒãƒ£ãƒƒãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
</script>
{% endblock %}